{% extends 'mgmbase.html' %}

{% block title %} Malwares State Overview {% endblock %}

{% block style%} {% endblock %}

{% block mgmContent %}

<ul class="list-group">

    <li class="list-group-item">
      <h3> RTC2 Malware Managment Dashboard</h3>
    </li>

    <li class="list-group-item">
        <h5> RTC2 Storage File Management</h5>
        <br>
        <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" id="customRadio1" name="example" value="customEx"
            onchange="toggleDiv('customRadio1')">
            <label class="form-check-label" for="customRadio1"> Upload a local file to C2 server </label>
        </div>

        <div class="form-check form-check-inline">
            <input type="radio" class="form-check-input" id="customRadio2" name="example" value="customEx"
              onchange="toggleDiv('customRadio2')">
            <label class="form-check-label" for="customRadio2"> Download a file from C2 to local </label>
        </div>

        <p> </p>

        <div id="content_1" style="display: none">
            <form action="/webfileupload" method="POST" enctype="multipart/form-data">
              <div class="input-group" style="max-width: 50%;">
                <input type="file" class="form-control" id="customFile"  name="file">
                <input type="submit" value="Upload">
              </div>
            </form>
            <br>
          </div>

        <div id="content_2" style="display: none">
            <form action="/webfiledownload" method="POST" enctype="multipart/form-data">
                <label> Select the download file : </label>
                <select id="downloadfilename" name="downloadfilename">
                    {% for filename in files %}
                      <option value="{{filename}}"> {{ filename }} </option>
                    {% endfor %}
                </select>
                <input type="submit" value="Download">
            </form>
            <br>
        </div>
    </li>
  
    <li class="list-group-item">
        <h5> Malwares' State Overview Table </h5>
        <br>
        <div class="table-responsive">
            <table class="table table-dark table-bordered">
                <thead>
                    <tr class="table table-danger">
                        <th>Malware_Idx</th>
                        <th>Malware_ID</th>
                        <th>Victim_IP</th>
                        <th>Connection</th>
                        <th>Last_Update </th>
                        <th>TotalTask</th>
                        <th>Finished</th>
                        <th>Accepted</th>
                        <th>Pending</th>
                        <th>Error</th>
                        <th>Deactived</th>
                    </tr>
                </thead>
                <tbody>
                    {% for post in posts['malwareInfo'] %}
                    <tr class="info">
                        <td> <b>{{ post['idx'] }}</b> </td>
                        <td> {{ post['id'] }} [
                            <a href="{{ url_for('peerstate', postID=post['idx'])}}" target="_blank">
                                Link to tasks detail
                            </a> ]
                        </td>
                        <td> {{ post['ipAddr'] }} </td>
                        <td>
                            {% if post['connected'] %}
                            <span class="badge bg-success"> online </span>
                            {% else %}
                            <span class="badge bg-warning"> offline </span>
                            {% endif %}
                        </td>
                        <td> {{ post['updateT'] }} </td>
                        <td> {{ post['total'] }} </td>
                        <td> {{ post['finish'] }} </td>
                        <td> {{ post['running'] }} </td>
                        <td> {{ post['pending'] }} </td>
                        <td> {{ post['error'] }} </td>
                        <td> {{ post['deactive'] }} </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </li>
</ul>

<script>
    function toggleDiv(radioName) {
      document.getElementById("content_1").style.display = "none";
      document.getElementById("content_2").style.display = "none";
      if (radioName == "customRadio1") {
        document.getElementById("content_1").style.display = "block";
      } else if (radioName == "customRadio2") {
        document.getElementById("content_2").style.display = "block";
      } 
    }

    $(document).ready(function () {
      $('[data-toggle="tooltip"]').tooltip();
      var socket = io();
      // Event handler for new connections.
      // The callback function is invoked when a connection with the
      // server is established.
      socket.on('connect', function () {
        socket.emit('cli_request', { data: 'malwaremgmt SIO client connected!' });
      });

      socket.on('pagerefersh', function (msg) {
        if (msg.data == 'malwaremgmt') {
        location.reload();
        }
      });
    });

  // Add the following code if you want the name of the file appear on select
  $(".custom-file-input").on("change", function () {
    var fileName = $(this).val().split("\\").pop();
    $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
  });

</script>

{% endblock %}