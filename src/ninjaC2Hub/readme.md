# **Command and Control (C2)** **Orchestrator**  

![](../../doc/img/c2/c2_00_title.png)

**Project Design Purpose** : The Red Team Command and Control (RTC2) server, commonly known as a C&C server, plays a pivotal role in cyber exercises and ranges. It serves as a centralized hub that red team members use to control and communicate with simulated compromised victims. This command center enables red team members or attackers to seamlessly issue instructions to the compromised machines, collect data from them, and coordinate various malicious activities within the exercise program. Our goal is to offer a comprehensive C2 server emulation solution designed for cyber exercise red team members to control and monitor the linked Ninja Agent. This solution allows them to seamlessly integrate different probing programs and malicious action programs, providing dynamic monitoring, scheduling, and control capabilities. The versatility of our solution makes it applicable across a range of fields, offering a robust platform for enhancing cyber defense readiness and testing the resilience of security measures.

```
# Created:     2024/05/23
# version:     v0.2.3
# Copyright:   Copyright (c) 2024 LiuYuancheng
# License:     MIT License
```

**Table of Contents**

[TOC]

------

### Introduction 

The Command and Control ( C2 ) servers are not inherently necessary or beneficial for legitimate and ethical purposes. However, there are situations in the realm of cybersecurity where the concept of command and control is used for defensive purposes, typically in the context of security operations and incident response. In these cases, organizations might employ C2 frameworks or systems to simulate the behavior of real-world attackers. These simulations help security professionals and organizations assess their ability to detect, respond to, and mitigate cyber threats. The overview work flow of the RTC2 is shown below : 

![](../../doc/img/rm_04_C2overview.png)

The Command and Control (C2) Orchestrator is "plug and play" red team C2 solution can be applied on below fields: 

**Cyber Exercise RTC2 Servers Simulation **

- **Cyber Exercise Red Teaming :** Utilized by red teams for the seamless control of simulated threats, including DDoS attacks simulator, data theft programs, and phishing data generators, providing a comprehensive toolset for enhancing defensive capabilities.
- **Forensic Traffic Research:** Designed to simulate and replicate attack scenarios, the C2 solution facilitates research and forensic analysis for C2 detection. This capability is instrumental in understanding and fortifying against potential cyber threats.

**Defensive RTC2 Threats Detection**

- **Red Team Operations:** In the context of cybersecurity exercises, red teams (ethical hackers) may use C2 frameworks to simulate the tactics, techniques, and procedures (TTPs) of real-world adversaries. This helps organizations test their defenses and improve their incident response capabilities.
- **Training and Simulation:** Security professionals use C2 frameworks for training purposes, allowing them to understand and practice responding to simulated cyber threats in a controlled environment.



#### RTC2-Hub Server Introduction   

This web hosting program serves as a centralized control hub for managing various Red-Teaming- Malicious-Action-Programs and handling user requirements. The key functionalities include:

-  **Web-UI Task Assignment:** Users can employ the intuitive web interface to remotely assign diverse tasks to specific Malicious Action Programs. This includes executing commands on the victim, uploading files from the victim's machine, injecting other programs, or recording the victim's user actions.
- **File Transfer "Bridge":** The C2 Hub Server acts as a secure "bridge," facilitating the seamless transfer of files between the victim machine and the user's local folder without requiring additional authorization on the victim's end.
- **Web Dashboard Monitoring:** Users have access to a comprehensive web dashboard, allowing them to monitor the  execution state of Malicious Action Programs on the victim machines.
- **Web-API Automation:** For streamlined control, users and their programs can leverage the web API to automate the control of all linked Malicious Action Programs within the C2 framework. This ensures a dynamic and responsive environment for managing and orchestrating red team operations effectively.



#### RTC2-Client Module Introduction

The RTC2 client is a multi-threading based client which user can hook it to their Red-Teaming-Malicious-Action-Programs to communicate with the C2 Hub Server. The key functionalities include:

- **Parallel Execution :** Running in parallel with the main thread of the Red-Teaming-Malicious-Action-Program, the RTC2 Client regularly reports the program's state and task execution results to the RTC2 Hub Server. This ensures real-time updates and streamlined coordination.
- **Task Assignment:** The RTC2 Client fetches detailed tasks assigned by the RTC2 Hub, facilitating the execution of related functions within the Red-Teaming-Malicious-Action-Program. This dynamic interaction enhances the adaptability of the client in responding to varied tasks.
- **File/Data Handling:** The client adeptly manages file and data translation requests from the RTC2 Hub, ensuring seamless and secure communication. This functionality ensures efficient and secure transfer of information between the Red-Teaming-Malicious-Action-Program and the C2 Hub Server.



------

### System Design

We have used the Python-Flask framework to construct our web hosting platform, offering a robust foundation for users. The system provides a multi-threading API handling function, enabling concurrent utilization by multiple users to control multiple Red-Teaming-Malicious-Action-Program simultaneously.

The system workflow is delineated below:

![](../../doc/img/c2/c2_01_workflow.png)

#### RTC2 Web Service API Design 

The RTC2 Web Service offers three distinct HTTP/HTTPS APIs designed to accommodate various requests:

1. **User Web Control API:** This API delivers a diverse user interface, empowering users to assign tasks to malware seamlessly. It includes multiple dashboards tailored for red team users, facilitating the monitoring of Red-Teaming-Malicious-Action-Program states and detailed execution tasks.
2. **Program Control API:** For enhanced flexibility, we provide an HTTP-POST interface, enabling red team users to automate the control of all functions accessible through the Web Control API. This feature allows users to seamlessly integrate their programs with RTC2, streamlining the execution of tasks.
3. **Malware Communication API:** Specifically designed to handle communication from RTC2 clients connected to Red-Teaming-Malicious-Action-Program, this API manages data retrieval, task assignment, and file transfers. It serves as a robust bridge for effective communication and coordination between the RTC2 server and the hooked Red-Teaming-Malicious-Action-Programs.

#### Data Manager Functionality 

The Data Manager serves as the central "database," meticulously storing comprehensive information about each registered Malicious Action Program. This includes a unique malware ID, victim IP address, task details, and intricate information for every taskâ€”such as `taskID`, `taskType`, `startTime`, `task repeat times`, `wait time before execution`, `task config parameters`, `task state,` and `task result`.

Upon red team members accessing the Red-Teaming-Malicious-Action-Program management web page, the Data Manager dynamically generates a malware state summary report. Furthermore, when navigating to the Red-Teaming-Malicious-Action-Program tasks page, the Data Manager retrieves and presents the malware's task summary report, enhancing visibility and control.

Upon the registration of a Malicious Action Program with the RTC2-Hub, the Data Manager receives and stores all re-configured task information. As an illustration, consider the example of a task where the Malicious Action Program is configured to upload a zipped file to the C2 server :

```
{	
	'taskID': 1,
    'taskType': 'upload',
    'startT': None,		# None means start immediatly if recevied 
    'repeat': 1,		# how many times to repeat the task.
    'exePreT': 0,		# time to wait before execution
    'taskData': [os.path.join(dirpath, "update_installer.zip")]
}
```

 

#### Malware Task Queue Manager 

The Malware Task Queue Manager plays a crucial role in RTC2, ensuring synchronization between tasks and the associated Malicious Action Programs while handling user-initiated task adjustments. This guarantees that the task queue of each Malicious Action Program aligns seamlessly with the RTC2 database. 

The following detailed steps outline the process when a user sets a task to request the C2 to upload a file:

1. A red team user initiates the task by specifying the upload file name through the web or program control API for Malicious Action Program-1.
2. The Task Queue Manager receives the request, generates detailed information for the file upload task, and enqueues it into Malicious Action Program-1's task queue.
3. Upon reporting to the RTC2-Hub, the Task Queue Manager dequeues the file upload task and transmits the task information to Malicious Action Program-1.
4. Malicious Action Program-1 enqueues the file upload task into its own task queue.
5. During the next execution of Malicious Action Program-1's task function, the program uploads the specified file to the RTC2-Hub.
6. The uploaded file is processed, and the Task Queue Manager updates the Data Manager's task record to reflect the completion of the task.

For each task displayed on the tasks dashboard, it will be under below five states : 

- **Task pending** : Task is enqueued in the RTC2-Hub task manager's sending queue. 
- **Task accepted** : Task information has been sent to related the Red-Teaming-Malicious-Action-Program. 
- **Task finished** : Task execution finished and state updated in the RTC2-Hub. 
- **Task deactivated** : Task is disabled in the Red-Teaming-Malicious-Action-Program. 
- **Task Error** : Tasks execution got error. 



------

### Program Setup

##### Development/Execution Environment : python 3.7.4+

##### Additional Lib/Software Need 

- Flask (version >=1.1.2) : https://flask.palletsprojects.com/en/3.0.x/
- Flask_SocketIO( version >=5.3.5) : https://flask-socketio.readthedocs.io/en/latest/
- requests (version >=2.28.1) : https://pypi.org/project/requests/

- Ettercap Installation : https://installati.one/install-ettercap-common-ubuntu-20-04/

##### Customized lib Needed

`ConfigLoader.py`, `Log.py`, `c2Client.py`, `c2Constants.py` `c2MwUtils.py`

##### Program File List

| Program File          | Execution Env            | Description                                                  |
| --------------------- | ------------------------ | ------------------------------------------------------------ |
| c2App.py              | python 3                 | Main flask webhost program.                                  |
| c2HubGlobal.py        | python 3                 | Global parameters module.                                    |
| c2DataManager.py      | python 3                 | Data manager module.                                         |
| c2Config_template.txt |                          | Config file.                                                 |
| SSLKeyLog/*           |                          | All the SSL connected peer's key log files if use https host type |
| cert/*                |                          | Https host certificate and key storage folder.               |
| fileFolder/*          |                          | All the files upload from malware/hacker, can also be download via download API. |
| templates/*.html      | html, javascript, Jinja2 | All the web pages (flask default config)                     |
| static/*              |                          | All the web page resources (flask default config)            |



------

### Program Usage 

For detailed usage please refer to the UsageManual.md file: [>Link](../../UsageManual.md)

#### Program Execution 

Follow the `c2Config_template.txt` to create the c2Config file:

```
# This is the config file template for the module <c2App.py>
# Setup the paramter with below format (every line follows <key>:<val> format, the
# key can not be changed):

#-----------------------------------------------------------------------------
# test mode flag, test mode will add a false malware in the C2
TEST_MD:False

# Init the flask execution parameters
#-----------------------------------------------------------------------------
# Init the connection protocal parameters

# Flag to indicate whether to use https: 
HTTPS:False

# https cert and key storage folder
CERT_DIR:cert
# https self signed cert files
CERT_FILE:cert.pem
KEY_FILE:key.pem

# Init th flag whether to save the connected peer's ssl key
RCD_SSL:True

# Init the folders 
#-----------------------------------------------------------------------------
# upload file storage folder
UPLOAD_FOLDER:filesFolder

# download file storage folder
DOWNLOAD_FOLDER:filesFolder

# Connected peer SSL key log folder
SSLKEYLOG_FOLDER:SSLKeyLog

#-----------------------------------------------------------------------------
# Init the Flask app parameters
FLASK_SER_PORT:5000
FLASK_DEBUG_MD:False
FLASK_MULTI_TH:True
```

For Linux and MAC user : 

```
Sudo python3 c2App.py
```

For Windows user (Or double click the `run.bat` file) : 

```
python c2App.py
```



#### Web UI dashboard

Open Web URL http://127.0.0.1:5000/

Introduction Page: 

![](../../doc/img/c2/c2_02_web01.png)

Malware Management Page

![](../../doc/img/c2/c2_03_web02.png)

Malware task management page

![](../../doc/img/c2/c2_04_web03.png)



------

>  Last edit by LiuYuancheng (liu_yuan_cheng@hotmail.com) at 25/05/2024, if you have any problem please free to message me.